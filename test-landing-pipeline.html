<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astradio Landing Pipeline Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .loading { background: #fef3c7; color: #92400e; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4338ca;
        }
        audio {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Astradio Landing Pipeline Test</h1>
        <p>Testing the complete music generation pipeline from backend to frontend</p>

        <div class="test-section">
            <h3>1. Backend API Test</h3>
            <button onclick="testBackend()">Test Backend Connection</button>
            <div id="backend-status"></div>
        </div>

        <div class="test-section">
            <h3>2. Chart Data Test</h3>
            <button onclick="testChartData()">Fetch Today's Chart</button>
            <div id="chart-status"></div>
        </div>

        <div class="test-section">
            <h3>3. Audio Generation Test</h3>
            <button onclick="testAudioGeneration()">Generate Audio</button>
            <div id="audio-status"></div>
        </div>

        <div class="test-section">
            <h3>4. Audio Playback Test</h3>
            <button onclick="testAudioPlayback()">Play Generated Audio</button>
            <audio id="testAudio" controls></audio>
            <div id="playback-status"></div>
        </div>

        <div class="test-section">
            <h3>5. Frontend Integration Test</h3>
            <button onclick="testFrontend()">Test Frontend Connection</button>
            <div id="frontend-status"></div>
        </div>

        <div class="test-section">
            <h3>6. Complete Pipeline Test</h3>
            <button onclick="runCompleteTest()">Run Complete Pipeline Test</button>
            <div id="pipeline-status"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://astradio-1.onrender.com';
        const FRONTEND_URL = 'https://astradio-l7i5o0bcx-nickalas-pauls-projects.vercel.app';
        let chartData = null;
        let audioId = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML = `<div class="status ${type}">[${timestamp}] ${message}</div>`;
            console.log(`[${elementId}] ${message}`);
        }

        async function testBackend() {
            try {
                log('backend-status', 'Testing backend connection...', 'loading');
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                log('backend-status', `âœ… Backend healthy: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                log('backend-status', `âŒ Backend error: ${error.message}`, 'error');
            }
        }

        async function testChartData() {
            try {
                log('chart-status', 'Fetching today\'s chart...', 'loading');
                const response = await fetch(`${API_URL}/api/ephemeris/today`);
                chartData = await response.json();
                const planetCount = Object.keys(chartData.chart.planets).length;
                log('chart-status', `âœ… Chart loaded with ${planetCount} planets`, 'success');
            } catch (error) {
                log('chart-status', `âŒ Chart error: ${error.message}`, 'error');
            }
        }

        async function testAudioGeneration() {
            if (!chartData) {
                log('audio-status', 'âŒ No chart data available. Fetch chart first.', 'error');
                return;
            }
            try {
                log('audio-status', 'Generating audio...', 'loading');
                const response = await fetch(`${API_URL}/api/audio/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'personal',
                        chartA: chartData.chart,
                        genre: 'ambient'
                    })
                });
                const data = await response.json();
                audioId = data.audioId;
                log('audio-status', `âœ… Audio generated: ${audioId}`, 'success');
            } catch (error) {
                log('audio-status', `âŒ Audio generation error: ${error.message}`, 'error');
            }
        }

        async function testAudioPlayback() {
            if (!audioId) {
                log('playback-status', 'âŒ No audio ID available. Generate audio first.', 'error');
                return;
            }
            try {
                log('playback-status', 'Testing audio playback...', 'loading');
                const audio = document.getElementById('testAudio');
                audio.src = `${API_URL}/api/audio/stream/${audioId}`;
                
                audio.oncanplay = () => {
                    log('playback-status', 'âœ… Audio loaded and ready to play', 'success');
                };
                
                audio.onerror = () => {
                    log('playback-status', 'âŒ Audio playback error', 'error');
                };
                
                // Try to play
                await audio.play();
                log('playback-status', 'âœ… Audio playing successfully', 'success');
            } catch (error) {
                log('playback-status', `âŒ Audio playback error: ${error.message}`, 'error');
            }
        }

        async function testFrontend() {
            try {
                log('frontend-status', 'Testing frontend connection...', 'loading');
                const response = await fetch(FRONTEND_URL);
                if (response.ok) {
                    log('frontend-status', 'âœ… Frontend accessible', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log('frontend-status', `âŒ Frontend error: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            log('pipeline-status', 'ðŸš€ Starting complete pipeline test...', 'loading');
            
            try {
                // 1. Test backend
                await testBackend();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 2. Test chart data
                await testChartData();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. Test audio generation
                await testAudioGeneration();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 4. Test frontend
                await testFrontend();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                log('pipeline-status', 'ðŸŽ‰ Complete pipeline test successful! All systems operational.', 'success');
                
            } catch (error) {
                log('pipeline-status', `âŒ Pipeline test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run backend test on load
        window.onload = () => {
            testBackend();
        };
    </script>
</body>
</html>
